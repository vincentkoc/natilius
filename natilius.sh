#!/bin/bash

# Natilius - Modular Mac Developer Environment Setup
# https://github.com/koconder/natilius

set -e

NATILIUS_DIR="$HOME/.natilius"
CONFIG_FILE="$HOME/.natiliusrc"

# Source utility functions and logging
source "$NATILIUS_DIR/lib/utils.sh"
source "$NATILIUS_DIR/lib/logging.sh"

# Load user configuration and export variables
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
    export $(grep -Ev '^#' "$CONFIG_FILE" | cut -d= -f1 | xargs)
else
    cp "$NATILIUS_DIR/.natiliusrc.example" "$CONFIG_FILE"
    log_info "Created default configuration file at $CONFIG_FILE"
    source "$CONFIG_FILE"
    export $(grep -Ev '^#' "$CONFIG_FILE" | cut -d= -f1 | xargs)
fi

# Set LOGFILE
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
LOGFILE="$NATILIUS_DIR/logs/natilius-setup-$TIMESTAMP.log"

mkdir -p "$NATILIUS_DIR/logs"

# Start logging
log_info "Logging enabled..."
log_info "Log file is located at [$LOGFILE]"

# Export LOGFILE so that it's available in sourced scripts
export LOGFILE

# Display the ASCII intro
echo -e "\033[0;33m"
cat << "EOF"
 ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
 ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚£¥‚£∂‚°ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
 ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£∞‚£æ‚£ø‚£ø‚£ø‚†Ä‚¢∏‚£ø‚£ø‚£ø‚£ø‚£∂‚£∂‚£§‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
 ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£¥‚°á‚¢Ä‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ä‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†ø‚†ì‚†Ä‚†Ä‚†Ä‚†Ä
 ‚†Ä‚†Ä‚†Ä‚†Ä‚£∞‚£ø‚£ø‚°Ä‚¢∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ä‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†ü‚†Å‚£†‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä
 ‚†Ä‚†Ä‚†Ä‚¢†‚£ø‚£ø‚£ø‚£á‚†Ä‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ä‚¢ª‚£ø‚£ø‚£ø‚°ø‚¢É‚£†‚£æ‚£ø‚£ø‚£ß‚°Ä‚†Ä‚†Ä
 ‚†Ä‚†Ä‚†Ä‚¢∏‚£ø‚£ø‚£ø‚£ø‚£Ü‚†ò‚¢ø‚£ø‚°ø‚†õ‚¢â‚†Ä‚†Ä‚†â‚†ô‚†õ‚£†‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚†Ä‚†Ä
 ‚†Ä‚†Ä‚††‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ß‚†à‚†ã‚¢Ä‚£¥‚£ß‚†Ä‚£ø‚°è‚¢†‚°Ä‚¢∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°á‚†Ä
 ‚†Ä‚†Ä‚£Ä‚†ô‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†á‚¢†‚£ø‚£ø‚£ø‚°Ñ‚†π‚†É‚†º‚†É‚†à‚†â‚†õ‚†õ‚†õ‚†õ‚†õ‚†ª‚†á‚†Ä
 ‚†Ä‚¢∏‚°ü‚¢†‚£§‚†â‚†õ‚†ø‚¢ø‚£ø‚†Ä‚¢∏‚£ø‚°ø‚†ã‚£†‚£§‚£Ñ‚†Ä‚£æ‚£ø‚£ø‚£∂‚£∂‚£∂‚£¶‚°Ñ‚†Ä‚†Ä‚†Ä
 ‚†Ä‚†∏‚†Ä‚£æ‚†è‚£∏‚£∑‚†Ç‚£†‚£§‚†Ä‚†ò‚¢Å‚£¥‚£æ‚£ø‚£ø‚£ø‚°Ü‚†ò‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ä‚†Ä‚†Ä‚†Ä
 ‚†Ä‚†Ä‚†Ä‚†õ‚†Ä‚£ø‚°ü‚†Ä‚¢ª‚£ø‚°Ñ‚†∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°Ä‚†ò‚£ø‚£ø‚£ø‚£ø‚†ü‚†Ä‚†Ä‚†Ä‚†Ä
 ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚†á‚†Ä‚†Ä‚¢ª‚°ø‚†Ä‚†à‚†ª‚£ø‚£ø‚£ø‚£ø‚£ø‚°á‚†Ä‚¢π‚£ø‚†ø‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
 ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ã‚†Ä‚†Ä‚†Ä‚°ò‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
                   _ _ _
              _   (_) (_)
  ____   ____| |_  _| |_ _   _  ___
 |  _ \ / _  |  _)| | | | | | |/___)
 | | | ( ( | | |__| | | | |_| |___ |
 |_| |_|\_||_|\___)_|_|_|\____(___/

 Welcome to Natilius

 Natilius is an automated script to help speed up
 development on a Mac machine by scaffolding
 all your key development apps, settings, dotfiles
 configuration, and have you up and running in no
 time. Developed by Vincent Koc (@koconder)

 This script assumes iCloud as the primary
 location for dotfiles and configuration.

 Starting Natilius...
EOF

echo -e "\033[0m"

# Prompt for sudo password at the start
log_info "Please provide your password to proceed with sudo privileges (may auto-skip)..."
sudo -v

# Keep-alive: update existing `sudo` time stamp until the script has finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

log_success "Sudo password validated"

# Run modules based on configuration
for module in "${ENABLED_MODULES[@]}"; do
    MODULE_PATH="$NATILIUS_DIR/modules/$module.sh"
    if [ -f "$MODULE_PATH" ]; then
        log_info "Running module: $module"
        source "$MODULE_PATH"
    else
        log_warning "Module not found: $module"
    fi
done

# Conclusion
echo -e | tee -a "$LOGFILE"
echo -e | tee -a "$LOGFILE"
echo -e "\033[0;32m[ üêö ]\033[0m \033[0;36mNatilius install script has completed!\033[0m" | tee -a "$LOGFILE"
echo -e "\033[0;33m"
cat << EOF
 Thanks for using Natilius :)
 Your logfile is saved at $LOGFILE

 You are welcome to leave feedback, comments, and issues
 directly on GitHub at (https://github.com/koconder/natilius).

 I also welcome PRs and suggestions to speed up the
 setup of your development environment.

 Thanks
 Vince

EOF
echo -e "\033[0m"
